name: CI/CD Pipeline - Next.js Docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: captwhite
  IMAGE_NAME: captwhite/aster-publicacio

jobs:
  ci_build:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies and Lint
        run: |
          npm ci
          npm run lint

      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: ci_build
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¤ Sync docker-compose.yml file to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST_ASTER }}
          username: ${{ secrets.SSH_USER_ASTER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: docker-compose-aster.yml
          target: /home/${{ secrets.SSH_USER_ASTER }}/workspaces/aster-publicacio

      - name: ðŸš€ Deploy containers and restart service
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ secrets.SSH_HOST_ASTER }}
          username: ${{ secrets.SSH_USER_ASTER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ConexiÃ³n SSH establecida, iniciando despliegue."
            cd /home/${{ secrets.SSH_USER_ASTER }}/workspaces/aster-publicacio

            echo "Creando fichero .env en el servidor..."
            echo "PRIVATE_KEY=${{ secrets.APPL_PRIVATE_KEY }}" > .env
            echo "CLIENT_EMAIL=${{ secrets.APPL_CLIENT_EMAIL }}" >> .env
            # AÃ±ade una lÃ­nea `echo` por cada variable de entorno que necesites

            echo "Asegurando que la red de Docker existe..."
            docker network inspect webnet-astro >/dev/null 2>&1 || docker network create webnet-astro

            echo "Actualizando y reiniciando contenedores..."            
            docker compose --file docker-compose-aster.yml down
            docker compose --file docker-compose-aster.yml pull
            docker compose --file docker-compose-aster.yml up -d
            echo "âœ… Despliegue de contenedores finalizado y levantado."
