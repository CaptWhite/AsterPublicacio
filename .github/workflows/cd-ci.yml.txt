name: CI/CD Pipeline - Next.js Docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: captwhite
  IMAGE_NAME: captwhite/aster-publicacio
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¤ Sync docker-compose.yml file to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST_ASTER }}
          username: ${{ secrets.SSH_USER_ASTER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: docker-compose-prod.yml
          target: /home/${{ secrets.SSH_USER_ASTER }}/workspaces/aster-publicacio

      - name: ðŸš€ Deploy containers and restart service
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ secrets.SSH_HOST_ASTER }}
          username: ${{ secrets.SSH_USER_ASTER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ConexiÃ³n SSH establecida, iniciando despliegue."
            cd /home/${{ secrets.SSH_USER_ASTER }}/workspaces/aster-publicacio

            echo "Creando fichero .env en el servidor..."
            echo "PRIVATE_KEY=${{ secrets.APPL_PRIVATE_KEY }}" > .env
            echo "CLIENT_EMAIL=${{ secrets.APPL_CLIENT_EMAIL }}" >> .env
            # AÃ±ade una lÃ­nea `echo` por cada variable de entorno que necesites

            echo "Asegurando que la red de Docker existe..."
            docker network inspect webnet-astro >/dev/null 2>&1 || docker network create webnet-astro

            echo "Actualizando y reiniciando contenedores..."
            docker compose --file docker-compose-prod.yml pull
            docker compose --file docker-compose-prod.yml down
            docker compose --file docker-compose-prod.yml up -d
            echo "âœ… Despliegue de contenedores finalizado y levantado."
